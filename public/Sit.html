<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>SIT</title>
        <meta name="viewport" content="width=device-width, user-scalable=no">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/semantic-ui/2.2.6/semantic.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/semantic-ui/2.2.6/semantic.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/3.6.2/firebase.js"></script>
        <script src="/js/conexion.js" ></script>
        <script src="/js/autentificar.js" ></script>
        <script>
            var empresa;
            var emailEmpresa;
            var inicioDirecto = 1;
            function newEmpresa(){
                var password = document.getElementById('password').value;
                if(password >= 6){
                        inicioDirecto = 0;
                        registro();
                        firebase.auth().onAuthStateChanged(function(user) {
                            firebase.database().ref('/Niveles/').once('value').then(function(snapshot) {
                                var ceo = snapshot.val().CEO;
                                firebase.database().ref('users/' + user.uid).set({
                                    administrador   : ceo,
                                    puesto          : 'CEO',
                                    area            : 'CEO',
                                    correo          : emailEmpresa,
                                    empresa         : empresa
                                });
                                firebase.database().ref('empresa/' + empresa).set({
                                    nombre          : empresa,
                                    mision          : 'Misión',
                                    vision          : 'Visión',
                                    valores         : 'Valores',
                                    responsable     : 'Responsable'
                                });
                            });
                        });
                        firebase.database().ref('empresasPendientes/'+empresa).remove();
                        setTimeout(function(){
                            inicioUnico();
                        }, 1000);
                }else{
                    alert('La contraseña debe contener al menos 6 caracteres.');
                }
            }
            function presiona(){
                var masDeUno = 0;
                firebase.database().ref('empresasPendientes/').on('child_added', function(data) {
                   firebase.database().ref('empresasPendientes/'+data.key).once('value').then(function(snapshot) {
                        emailEmpresa = document.getElementById('email').value;
                        var email2 = snapshot.val().correoCEO;
                        empresa = data.key;
                        if(emailEmpresa == email2){
                            masDeUno = 1;
                            $('#handleLogin').hide();
                            $('#resetPass').hide();
                            $('#registroEmpresa').show();
                            $("#registroEmpresa").text('Registro para '+data.key);
                            document.getElementById('registroEmpresa').addEventListener('click', newEmpresa, false);
                        }else if(masDeUno == 0){
                            $('#registroEmpresa').hide();
                            $('#handleLogin').show();
                            $('#resetPass').show();
                        }
                    });
                });
            }
            function inicioUnico(){
                var user = firebase.auth().currentUser;
                firebase.database().ref('/users/' + user.uid).once('value').then(function(snapshot) {
                    var administrador = snapshot.val().administrador;
                    firebase.database().ref('/Niveles/').once('value').then(function(snapshot) {
                        var dios        = snapshot.val().Dios;
                        var ceo         = snapshot.val().CEO;
                        var directores  = snapshot.val().Directores;
                        var jefes       = snapshot.val().Jefes;
                        var subordinados= snapshot.val().Subordinados;
                        switch(administrador){
                            case dios:
                                window.location="https://aleph-b9912.firebaseapp.com/MainAleph.html";
                                break;
                            case ceo:
                                window.location="https://aleph-b9912.firebaseapp.com/MainCeo.html";
                                break;
                            case directores:
                                break;
                            case jefes:
                                break;
                            case subordinados:
                                break;
                            default:
                                alert('default');
                        }
                    });
                });
            }
            function initApp() {
                alert(inicioDirecto);
                alert('user:');
                  firebase.auth().onAuthStateChanged(function(user) {
                    if (user && inicioDirecto == 1) {
                        inicioUnico();
                    }
                  });
                document.getElementById('handleLogin').addEventListener('click', toggleSignIn, false);
                document.getElementById('resetPass').addEventListener('click', sendPasswordReset, false);
                document.getElementById('logout').addEventListener('click', logout, false);
                document.getElementById('email').addEventListener('keyup', presiona, false);
                //document.getElementById('registroEmpresa').addEventListener('click', newEmpresa, false);
                $('#registroEmpresa').hide();
            }
            window.onload = function() {
              initApp();
            };
            function logout(){
                firebase.auth().signOut();
                alert('Fuera');
            }
        </script>
        <style>
            body{

            }
            body > .grid {
              height: 100%;
            }
            .column {
              max-width: 450px;
            margin-top: 200px;
            }
             .footer.segment {
                display: inline-block;
                 width: 100%;
                 height: 35%;
            }
        </style>
    </head>
    <body>
        <!--<header id="barraMenu"></header>
        <!--  -->
        <div class="ui footer inverted teal segment ">
            <div class="ui middle aligned center aligned grid">
                  <div class="column">
                    <div class="ui large form">
                      <div class="ui stacked segment">
                        <div class="field">
                         <div class="ui left icon input">
                            <!--<i class="user icon"></i> -->
                            <input type="text" class="inputTxt" id="email" placeholder="Correo Electronico">
                          </div>
                        </div>
                        <div class="field">
                          <div class="ui left icon input">
        <!--                    <i class="lock icon"></i>-->
                            <input type="password" id="password" placeholder="Contraseña">
                          </div>
                        </div>
                            <button class="ui fluid large teal submit button" id="handleLogin">Ingresar</button>
                            <button class="ui fluid large teal submit button" id="resetPass">Resetear contraseña</button>
                            <button class="ui fluid large teal submit button" id="registroEmpresa"></button>
                          <div class="item">
                            <div class="ui fluid large teal submit button" id="logout">Salir</div>
                        </div>
                      </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <!--<script src="js/traerContenido.js"></script>-->
</html>
